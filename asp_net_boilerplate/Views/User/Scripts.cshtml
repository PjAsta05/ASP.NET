<script>
    $(document).ready(function () {
        initTable();
    });

    function initTable() {
         var table = $('#userTable').DataTable({
             "processing": true,
             "serverSide": true,
             "bDestroy": true,
             "orderMulti": false,
             "pageLength": 10,
             "bInfo": true,
             "lengthChange": true,
             "searching": true,
             "ajax": {
                 "url": "@Url.Action("LoadUser")",
                 "type": "POST",
             },
             "columns": [
                 { render: function (data, type, row, meta) { return meta.row + 1; }, orderable: false },
                 { data: "username", orderable: false },
                 { data: "name", orderable: false },
                 { data: "description", orderable: false },
                 { data: "action", orderable: false }
             ],
         });
    };

    function reloadTable() {
        $('#userTable').DataTable().ajax.reload(null, false);
    }

    function ShowData(user_id){
        $.get('@Url.Action("Get")', { user_id: user_id }, function(data){
            var tbody = $('#detailTable tbody');
            tbody.empty();

            var index = 1;
            for(var key in data){
                if (key !== "user_id" && key !== "action" && key !== "password" && key !== "is_deleted") {
                    let displayKey = key;
                    if (key === "is_allow_login") {
                        displayKey = "allow login";
                    } else {
                        displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    }
                    tbody.append('<tr>' +
                        '<td>' + displayKey + '</td>' +
                        '<td>' + data[key] + '</td>' +
                        '</tr>');
                }
            }

            $('#showModal').modal('show');
        });
    }


    function AddData() {
        $('#modalTitle').text('Add User');
        $('#saveForm')[0].reset();
        $('#is_allow_login').prop('checked', false);
        $('#user_id').val('');
        $('.add-only').show();
        $('#password').prop('required', true);
        $('#confirm_password').prop('required', true);
        $('#dataModal').modal('show');
    }

    function EditData(user_id) {
        $.get('@Url.Action("Get")', { user_id: user_id }, function (data) {
            $('#modalTitle').text('Edit User');
            $('#user_id').val(data.user_id);
            $('#username').val(data.username);
            $('#name').val(data.name);
            $('#description').val(data.description);
            $('#is_allow_login').prop('checked', data.is_allow_login === true || data.is_allow_login === 1);
            $('.add-only').hide();
            $('#password').prop('required', false);
            $('#confirm_password').prop('required', false);
            $('#dataModal').modal('show');
        });
    }

    function ChangePassword(user_id) {
        $.get('@Url.Action("Get")', { user_id: user_id }, function (data) {
            $('#user_id').val(data.user_id);
            $('#savePassword')[0].reset();
            $('#passwordModal').modal('show');
        });
    }

    function DeleteData(user_id) {
        swal({
            title: "Confirmation",
            text: "Are you sure you want to delete this data?",
            icon: "warning",
            buttons: ["No", "Yes"],
            dangerMode: true
        }).then(function(isDelete){
            if(isDelete){
                $.post('@Url.Action("Delete")', { user_id: user_id }, function(status){
                    if(status == 'success'){
                        swal("Deleted!", "User has been deleted.", "success");
                        reloadTable();
                    } else {
                        swal("Failed!", "Failed to delete: " + status, "error");
                    }
                });
            } else {
                swal("Cancelled", "User deletion cancelled.", "info");
            }
        });
    }

    $('#saveForm').submit(function(e){
        e.preventDefault();

        var isAdd = $('#user_id').val() === '';

        if (isAdd) {
            if ($('#password').val() !== $('#confirm_password').val()) {
                swal("Warning", "Password and Confirm Password do not match!", "warning");
                return;
            }
        }

        var formData = {
            user_id: $('#user_id').val(),
            username: $('#username').val(),
            name: $('#name').val(),
            description: $('#description').val(),
            password: isAdd ? $('#password').val() : null,
            is_allow_login: $('#is_allow_login').is(':checked'),
        };

        swal({
            title: "Save user?",
            text: "Are you sure you want to save this user?",
            icon: "info",
            buttons: ["No", "Yes"]
        }).then(function(isSave){
            if(isSave){
                $.post('@Url.Action("Store")', formData, function(status){
                    if(status == 'success'){
                        $('#dataModal').modal('hide');
                        swal("Saved!", "User saved successfully.", "success");
                        reloadTable();
                    } else {
                        swal("Failed!", "Failed to save: " + status, "error");
                    }
                });
            } else {
                swal("Cancelled", "Save action cancelled.", "info");
            }
        });
    });

    $('#savePassword').submit(function(e){
        e.preventDefault();
        if ($('#new_password').val() !== $('#confirm_new_password').val()) {
            swal("Warning", "Password and Confirm Password do not match!", "warning");
            return;
        }

        var formData = {
            user_id: $('#user_id').val(),
            old_password: $('#old_password').val(),
            new_password: $('#new_password').val(),
        };

        swal({
            title: "Change password?",
            text: "Are you sure you want to change the password?",
            icon: "info",
            buttons: ["No", "Yes"]
        }).then(function(isSave){
            if(isSave){
                $.post('@Url.Action("ChangePass")', formData, function(status){
                    if(status == 'success'){
                        $('#passwordModal').modal('hide');
                        swal("Changed!", "Password changed successfully.", "success");
                        reloadTable();
                    } else {
                        swal("Failed!", "Failed to change password: " + status, "error");
                    }
                });
            } else {
                swal("Cancelled", "Change password action cancelled.", "info");
            }
        });
    });
</script>